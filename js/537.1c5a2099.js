"use strict";(self["webpackChunkgcodeviewer_site"]=self["webpackChunkgcodeviewer_site"]||[]).push([[537],{90537:function(e,t,r){r.r(t),r.d(t,{_ENVTextureLoader:function(){return b}});var o=r(88658),n=r(25412),a=r(27143),i=r(53350),l=r(89324),s=r(45647),u=(r(88005),r(77334)),c=r(30658);r(6454);var p=r(4906);s.V.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(s.V.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=p.$.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then((e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0}))),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});r(58158);const d="image/png",h=2,f=[134,22,135,150,246,214,150,54];function m(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let i=0;i<f.length;i++)if(t.getUint8(r++)!==f[i])return c.Y.Error("Not a babylon environment map"),null;let o="",n=0;while(n=t.getUint8(r++))o+=String.fromCharCode(n);let a=JSON.parse(o);return a=y(a),a.specular&&(a.specular.specularDataPosition=r,a.specular.lodGenerationScale=a.specular.lodGenerationScale||.8),a}function y(e){if(e.version>h)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${h}".`);return 2===e.version||(e={...e,version:2,imageType:d}),e}function x(e,t){t=y(t);const r=t.specular;let o=Math.log2(t.width);if(o=Math.round(o)+1,r.mipmaps.length!==6*o)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const n=new Array(o);for(let a=0;a<o;a++){n[a]=new Array(6);for(let t=0;t<6;t++){const o=r.mipmaps[6*a+t];n[a][t]=new Uint8Array(e.buffer,e.byteOffset+r.specularDataPosition+o.position,o.length)}}return n}function _(e,t,r){r=y(r);const o=r.specular;if(!o)return Promise.resolve();e._lodGenerationScale=o.lodGenerationScale;const n=x(t,r);return w(e,n,r.imageType)}function g(e,t,r,o,n,a,i,l,s,u,c){return new Promise(((p,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,(e=>{d(e)}),e);o?.onEffectCreatedObservable.addOnce((l=>{l.executeWhenCompiled((()=>{o.externalTextureSamplerBinding=!0,o.onApply=o=>{o._bindTexture("textureSampler",r),o.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([o],u,!0,a,i),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(n),p())}))}))}else{if(t._uploadImageToTexture(c,e,a,i),l){const r=s[i];r&&t._uploadImageToTexture(r._texture,e,a,0)}p()}}))}async function w(e,t,n=d){if(!o.w1.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const i=(0,a.uc)(e.width)+1,c=e.getEngine();let p=!1,h=!1,f=null,m=null,y=null;const x=c.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,c.updateTextureSamplingMode(3,e),x.textureLOD?c._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(p=!0,e.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(p=!0,e.type=1):p=!1:(p=!1,h=!0,y={});let _=0;if(p)c.isWebGPU?(_=1,await r.e(7344).then(r.bind(r,77344))):await r.e(630).then(r.bind(r,90630)),f=new u.D("rgbdDecode","rgbdDecode",null,null,1,null,3,c,!1,void 0,e.type,void 0,null,!1,void 0,_),e._isRGBD=!1,e.invertY=!1,m=c.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,h){const t=3,r=e._lodGenerationScale,o=e._lodGenerationOffset;for(let n=0;n<t;n++){const a=n/(t-1),u=1-a,p=o,d=(i-1)*r+o,h=p+(d-p)*u,f=Math.round(Math.min(Math.max(h,0),d)),m=new l.l(c,2);m.isCube=!0,m.invertY=!0,m.generateMipMaps=!1,c.updateTextureSamplingMode(2,m);const x=new s.V(null);switch(x._isCube=!0,x._texture=m,y[f]=x,n){case 0:e._lodTextureLow=x;break;case 1:e._lodTextureMid=x;break;case 2:e._lodTextureHigh=x;break}}}const w=[];for(let r=0;r<t.length;r++)for(let o=0;o<6;o++){const a=t[r][o],i=new Blob([a],{type:n}),l=URL.createObjectURL(i);let s;if(c._features.forceBitmapOverHTMLImageElement)s=c.createImageBitmap(i,{premultiplyAlpha:"none"}).then((t=>g(t,c,p,f,l,o,r,h,y,m,e)));else{const t=new Image;t.src=l,s=new Promise(((n,a)=>{t.onload=()=>{g(t,c,p,f,l,o,r,h,y,m,e).then((()=>n())).catch((e=>{a(e)}))},t.onerror=e=>{a(e)}}))}w.push(s)}if(t.length<i){let r;const o=Math.pow(2,i-1-t.length),n=o*o*4;switch(e.type){case 0:r=new Uint8Array(n);break;case 2:r=new Uint16Array(n);break;case 1:r=new Float32Array(n);break}for(let a=t.length;a<i;a++)for(let t=0;t<6;t++)c._uploadArrayBufferViewToTexture(e,r,t,a)}return Promise.all(w).then((()=>{m&&(c._releaseTexture(e),m._swapAndDie(e)),f&&f.dispose(),h&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))}function T(e,t){t=y(t);const r=t.irradiance;if(!r)return;const o=new i.i;n.P.FromArrayToRef(r.x,0,o.x),n.P.FromArrayToRef(r.y,0,o.y),n.P.FromArrayToRef(r.z,0,o.z),n.P.FromArrayToRef(r.xx,0,o.xx),n.P.FromArrayToRef(r.yy,0,o.yy),n.P.FromArrayToRef(r.zz,0,o.zz),n.P.FromArrayToRef(r.yz,0,o.yz),n.P.FromArrayToRef(r.zx,0,o.zx),n.P.FromArrayToRef(r.xy,0,o.xy),e._sphericalPolynomial=o}class b{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,o,n){if(Array.isArray(e))return;const a=m(e);if(a){t.width=a.width,t.height=a.width;try{T(t,a),_(t,e,a).then((()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()}),(e=>{n?.("Can not upload environment levels",e)}))}catch(i){n?.("Can not upload environment file",i)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}}}]);
//# sourceMappingURL=537.1c5a2099.js.map