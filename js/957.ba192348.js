"use strict";(self["webpackChunkgcodeviewer_site"]=self["webpackChunkgcodeviewer_site"]||[]).push([[957],{50957:function(e,t,s){s.r(t),s.d(t,{_BasisTextureLoader:function(){return _}});var a,r=s(88658),n=s(27292),o=s(89324);function c(){const e={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let t=null;function s(t,s){let a=null;return t.supportedCompressionFormats&&(a=t.supportedCompressionFormats.astc?e.cTFASTC_4x4:t.supportedCompressionFormats.bc7?e.cTFBC7:t.supportedCompressionFormats.s3tc?s.hasAlpha?e.cTFBC3:e.cTFBC1:t.supportedCompressionFormats.pvrtc?s.hasAlpha?e.cTFPVRTC1_4_RGBA:e.cTFPVRTC1_4_RGB:t.supportedCompressionFormats.etc2?e.cTFETC2:t.supportedCompressionFormats.etc1?e.cTFETC1:e.cTFRGB565),a}function a(e){const t=e.getHasAlpha(),s=e.getNumImages(),a=[];for(let n=0;n<s;n++){const t={levels:[]},s=e.getNumLevels(n);for(let a=0;a<s;a++){const s={width:e.getImageWidth(n,a),height:e.getImageHeight(n,a)};t.levels.push(s)}a.push(t)}const r={hasAlpha:t,images:a};return r}function r(e,t,s,a,r){const o=e.getImageTranscodedSizeInBytes(t,s,a);let c=new Uint8Array(o);if(!e.transcodeImage(c,t,s,a,1,0))return null;if(r){const a=e.getImageWidth(t,s)+3&-4,r=e.getImageHeight(t,s)+3&-4;c=n(c,0,a,r)}return c}function n(e,t,s,a){const r=new Uint16Array(4),n=new Uint16Array(s*a),o=s/4,c=a/4;for(let i=0;i<c;i++)for(let a=0;a<o;a++){const c=t+8*(i*o+a);r[0]=e[c]|e[c+1]<<8,r[1]=e[c+2]|e[c+3]<<8,r[2]=(2*(31&r[0])+1*(31&r[1]))/3|(2*(2016&r[0])+1*(2016&r[1]))/3&2016|(2*(63488&r[0])+1*(63488&r[1]))/3&63488,r[3]=(2*(31&r[1])+1*(31&r[0]))/3|(2*(2016&r[1])+1*(2016&r[0]))/3&2016|(2*(63488&r[1])+1*(63488&r[0]))/3&63488;for(let t=0;t<4;t++){const o=e[c+4+t];let l=(4*i+t)*s+4*a;n[l++]=r[3&o],n[l++]=r[o>>2&3],n[l++]=r[o>>4&3],n[l++]=r[o>>6&3]}}return n}onmessage=n=>{if("init"===n.data.action){if(n.data.url)try{importScripts(n.data.url)}catch(o){postMessage({action:"error",error:o})}t||(t=BASIS({wasmBinary:n.data.wasmBinary})),null!==t&&t.then((e=>{BASIS=e,e.initializeBasis(),postMessage({action:"init"})}))}else if("transcode"===n.data.action){const t=n.data.config,o=n.data.imageData,c=new BASIS.BasisFile(o),i=a(c);let l=n.data.ignoreSupportedFormats?null:s(n.data.config,i),T=!1;null===l&&(T=!0,l=i.hasAlpha?e.cTFBC3:e.cTFBC1);let d=!0;c.startTranscoding()||(d=!1);const u=[];for(let e=0;e<i.images.length;e++){if(!d)break;const s=i.images[e];if(void 0===t.loadSingleImage||t.loadSingleImage===e){let a=s.levels.length;!1===t.loadMipmapLevels&&(a=1);for(let t=0;t<a;t++){const a=s.levels[t],n=r(c,e,t,l,T);if(!n){d=!1;break}a.transcodedPixels=n,u.push(a.transcodedPixels.buffer)}}}c.close(),c.delete(),T&&(l=-1),d?postMessage({action:"transcode",success:d,id:n.data.id,fileInfo:i,format:l},u):postMessage({action:"transcode",success:d,id:n.data.id})}}}function i(e,t,s){return new Promise(((a,n)=>{const o=t=>{"init"===t.data.action?(e.removeEventListener("message",o),a(e)):"error"===t.data.action&&n(t.data.error||"error initializing worker")};e.addEventListener("message",o),e.postMessage({action:"init",url:s?r.w1.GetBabylonScriptURL(s):void 0,wasmBinary:t},[t])}))}(function(e){e[e["cTFETC1"]=0]="cTFETC1",e[e["cTFETC2"]=1]="cTFETC2",e[e["cTFBC1"]=2]="cTFBC1",e[e["cTFBC3"]=3]="cTFBC3",e[e["cTFBC4"]=4]="cTFBC4",e[e["cTFBC5"]=5]="cTFBC5",e[e["cTFBC7"]=6]="cTFBC7",e[e["cTFPVRTC1_4_RGB"]=8]="cTFPVRTC1_4_RGB",e[e["cTFPVRTC1_4_RGBA"]=9]="cTFPVRTC1_4_RGBA",e[e["cTFASTC_4x4"]=10]="cTFASTC_4x4",e[e["cTFATC_RGB"]=11]="cTFATC_RGB",e[e["cTFATC_RGBA_INTERPOLATED_ALPHA"]=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",e[e["cTFRGBA32"]=13]="cTFRGBA32",e[e["cTFRGB565"]=14]="cTFRGB565",e[e["cTFBGR565"]=15]="cTFBGR565",e[e["cTFRGBA4444"]=16]="cTFRGBA4444",e[e["cTFFXT1_RGB"]=17]="cTFFXT1_RGB",e[e["cTFPVRTC2_4_RGB"]=18]="cTFPVRTC2_4_RGB",e[e["cTFPVRTC2_4_RGBA"]=19]="cTFPVRTC2_4_RGBA",e[e["cTFETC2_EAC_R11"]=20]="cTFETC2_EAC_R11",e[e["cTFETC2_EAC_RG11"]=21]="cTFETC2_EAC_RG11"})(a||(a={}));const l={JSModuleURL:`${r.w1._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${r.w1._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},T=(e,t)=>{let s;switch(e){case a.cTFETC1:s=36196;break;case a.cTFBC1:s=33776;break;case a.cTFBC4:s=33779;break;case a.cTFASTC_4x4:s=37808;break;case a.cTFETC2:s=37496;break;case a.cTFBC7:s=36492;break}if(void 0===s)throw"The chosen Basis transcoder format is not currently supported";return s};let d=null,u=null,F=0;const p=!1,g=()=>(d||(d=new Promise(((e,t)=>{u?e(u):r.w1.LoadFileAsync(r.w1.GetBabylonScriptURL(l.WasmModuleURL)).then((s=>{if("function"!==typeof URL)return t("Basis transcoder requires an environment with a URL constructor");const a=URL.createObjectURL(new Blob([`(${c})()`],{type:"application/javascript"}));u=new Worker(a),i(u,s,l.JSModuleURL).then(e,t)})).catch(t)}))),d),f=(e,t)=>{const s=e instanceof ArrayBuffer?new Uint8Array(e):e;return new Promise(((e,a)=>{g().then((()=>{const r=F++,n=t=>{"transcode"===t.data.action&&t.data.id===r&&(u.removeEventListener("message",n),t.data.success?e(t.data):a("Transcode is not supported on this device"))};u.addEventListener("message",n);const o=new Uint8Array(s.byteLength);o.set(new Uint8Array(s.buffer,s.byteOffset,s.byteLength)),u.postMessage({action:"transcode",id:r,imageData:o,config:t,ignoreSupportedFormats:p},[o.buffer])}),(e=>{a(e)}))}))},C=(e,t)=>{let s=t._gl?.TEXTURE_2D;e.isCube&&(s=t._gl?.TEXTURE_CUBE_MAP),t._bindTextureDirectly(s,e,!0)},h=(e,t)=>{const s=e.getEngine();for(let c=0;c<t.fileInfo.images.length;c++){const i=t.fileInfo.images[c].levels[0];if(e._invertVScale=e.invertY,-1===t.format||t.format===a.cTFRGB565)if(e.type=10,e.format=4,!s._features.basisNeedsPOT||Math.log2(i.width)%1===0&&Math.log2(i.height)%1===0)e._invertVScale=!e.invertY,e.width=i.width+3&-4,e.height=i.height+3&-4,e.samplingMode=2,C(e,s),s._uploadDataToTextureDirectly(e,new Uint16Array(i.transcodedPixels.buffer),c,0,4,!0);else{const t=new o.l(s,2);e._invertVScale=e.invertY,t.type=10,t.format=4,t.width=i.width+3&-4,t.height=i.height+3&-4,C(t,s),s._uploadDataToTextureDirectly(t,new Uint16Array(i.transcodedPixels.buffer),c,0,4,!0),s._rescaleTexture(t,e,s.scenes[0],s._getInternalFormat(4),(()=>{s._releaseTexture(t),C(e,s)}))}else{e.width=i.width,e.height=i.height,e.generateMipMaps=t.fileInfo.images[c].levels.length>1;const a=m.GetInternalFormatFromBasisFormat(t.format,s);e.format=a,C(e,s),t.fileInfo.images[c].levels.forEach(((t,r)=>{s._uploadCompressedDataToTextureDirectly(e,a,t.width,t.height,t.transcodedPixels,c,r)})),!s._features.basisNeedsPOT||Math.log2(e.width)%1===0&&Math.log2(e.height)%1===0||(r.w1.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),e._cachedWrapU=n.x.CLAMP_ADDRESSMODE,e._cachedWrapV=n.x.CLAMP_ADDRESSMODE)}}},m={JSModuleURL:l.JSModuleURL,WasmModuleURL:l.WasmModuleURL,GetInternalFormatFromBasisFormat:T,TranscodeAsync:f,LoadTextureFromTranscodeResult:h};Object.defineProperty(m,"JSModuleURL",{get:function(){return l.JSModuleURL},set:function(e){l.JSModuleURL=e}}),Object.defineProperty(m,"WasmModuleURL",{get:function(){return l.WasmModuleURL},set:function(e){l.WasmModuleURL=e}});class _{constructor(){this.supportCascades=!1}loadCubeData(e,t,s,a,n){if(Array.isArray(e))return;const o=t.getEngine().getCaps(),c={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};f(e,c).then((e=>{const s=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;h(t,e),t.getEngine()._setCubeMapTextureParams(t,s),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),a&&a()})).catch((e=>{const s="Failed to transcode Basis file, transcoding may not be supported on this device";r.w1.Warn(s),t.isReady=!0,n&&n(e)}))}loadData(e,t,s){const a=t.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,astc:!!a.astc,bc7:!!a.bptc}};f(e,n).then((e=>{const a=e.fileInfo.images[0].levels[0],r=e.fileInfo.images[0].levels.length>1&&t.generateMipMaps;s(a.width,a.height,r,-1!==e.format,(()=>{h(t,e)}))})).catch((e=>{r.w1.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),r.w1.Warn(`Failed to transcode Basis file: ${e}`),s(0,0,!1,!1,(()=>{}),!0)}))}}}}]);
//# sourceMappingURL=957.ba192348.js.map